# Tour Package Query - Variants Tab Quick Reference

## Overview
The enhanced Variants Tab now provides comprehensive information about selected package variants, including hotel mappings, room allocations, and detailed pricing calculations.

## Visual Structure

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸŒŸ SELECTED PACKAGE VARIANTS                                â”‚
â”‚    Variants from: "Kashmir Paradise Tour"                   â”‚
â”‚    Total: 3  [Has Default]                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ğŸŒŸ  â”‚    ğŸŒŸ     â”‚     ğŸŒŸ     â”‚
â”‚Luxury â”‚  Premium  â”‚  Standard  â”‚
â”‚       â”‚  [Default]â”‚            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

When "Luxury" variant selected:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸŒŸ Variant Details                                           â”‚
â”‚                                                               â”‚
â”‚ Variant Name: Luxury                                         â”‚
â”‚ Price Modifier: +15%                                         â”‚
â”‚ Description: Premium accommodations with exclusive perks     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ¨ Hotel Mappings (7)                                        â”‚
â”‚                                                               â”‚
â”‚ â–¼ Day 1 ğŸ¨ Hotel Taj                           [Modified]    â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚   â”‚ ğŸ–¼ï¸ [Hotel Images Grid - 4 images]                    â”‚ â”‚
â”‚   â”‚                                                         â”‚ â”‚
â”‚   â”‚ ğŸ“ Hotel Details                                       â”‚ â”‚
â”‚   â”‚    City: Srinagar                                      â”‚ â”‚
â”‚   â”‚    Rating: 5 Star                                      â”‚ â”‚
â”‚   â”‚                                                         â”‚ â”‚
â”‚   â”‚ ğŸ“… Itinerary Info                                      â”‚ â”‚
â”‚   â”‚    Arrival in Kashmir - Welcome to Paradise            â”‚ â”‚
â”‚   â”‚    Transfer to hotel, evening Dal Lake visit           â”‚ â”‚
â”‚   â”‚                                                         â”‚ â”‚
â”‚   â”‚ ğŸ›ï¸ Room Allocations (3)                              â”‚ â”‚ â—„â”€â”€ NEW!
â”‚   â”‚    ğŸ‘¥ [Deluxe Room] [Double] [ğŸ´ MAP] Ã—2             â”‚ â”‚
â”‚   â”‚       Guests: John Doe, Jane Doe                       â”‚ â”‚
â”‚   â”‚       Voucher: V123456                                 â”‚ â”‚
â”‚   â”‚    ğŸ‘¥ [Suite] [Triple] [ğŸ´ AP] Ã—1                    â”‚ â”‚
â”‚   â”‚       Guests: Family Group A                           â”‚ â”‚
â”‚   â”‚    ğŸ‘¥ [Standard] [Single] [ğŸ´ CP] Ã—1                 â”‚ â”‚
â”‚   â”‚                                                         â”‚ â”‚
â”‚   â”‚ [âœï¸ Change Hotel]                                      â”‚ â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                               â”‚
â”‚ â–¼ Day 2 ğŸ¨ Houseboat Deluxe                                 â”‚
â”‚   ... (similar structure)                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ’° Pricing Details (4)                                       â”‚
â”‚                                                               â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ 1ï¸âƒ£  ğŸ“… 15 Dec 2024 - 31 Dec 2024  [Peak Season]      â”‚   â”‚
â”‚ â”‚                                                        â”‚   â”‚
â”‚ â”‚ ğŸ´ MAP  ğŸ¨ 2 Rooms  ğŸš— Innova  [Group Pricing]        â”‚   â”‚
â”‚ â”‚                                                        â”‚   â”‚
â”‚ â”‚ ğŸ§¾ Price Breakdown                                    â”‚   â”‚
â”‚ â”‚    Per Person (Adult)               â‚¹25,000           â”‚   â”‚
â”‚ â”‚    Per Person (Child 5-12)          â‚¹15,000           â”‚   â”‚
â”‚ â”‚    Hotel Charges                    â‚¹30,000           â”‚   â”‚
â”‚ â”‚    Transport Charges                â‚¹12,000           â”‚   â”‚
â”‚ â”‚    Guide Charges                     â‚¹5,000           â”‚   â”‚
â”‚ â”‚    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€           â”‚   â”‚
â”‚ â”‚    Total                            â‚¹87,000           â”‚   â”‚
â”‚ â”‚                                                        â”‚   â”‚
â”‚ â”‚ â„¹ï¸  Prices inclusive of all taxes                    â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                               â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ 2ï¸âƒ£  ğŸ“… 01 Jan 2025 - 15 Jan 2025  [Off Season]       â”‚   â”‚
â”‚ â”‚    ... (similar structure)                            â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ§® Price Calculation Summary                          â—„â”€â”€ NEW!â”‚
â”‚                                                               â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚   Pricing    â”‚  Avg. Price  â”‚      Grand Total         â”‚ â”‚
â”‚ â”‚   Periods    â”‚  per Period  â”‚                          â”‚ â”‚
â”‚ â”‚              â”‚              â”‚                          â”‚ â”‚
â”‚ â”‚      4       â”‚  â‚¹78,500     â”‚       â‚¹3,14,000         â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                               â”‚
â”‚ ğŸ“… Pricing Date Range                                        â”‚
â”‚    15 Dec 2024 - 31 Mar 2025                                 â”‚
â”‚                                                               â”‚
â”‚ âš ï¸  This variant has a +15% price modifier applied           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Key Features

### 1. Variant Selection Display
- Shows which variants are selected from the tour package
- Indicates default variant with badge
- Tab-based navigation between variants

### 2. Hotel Mappings with Room Allocations (NEW!)
- Each day's hotel is displayed with details
- **Room allocations now visible** including:
  - Room type and occupancy
  - Meal plan 
  - Number of rooms
  - Guest names
  - Voucher numbers
- Ability to change hotels per variant
- Visual indicators for modified hotels

### 3. Detailed Pricing Information
- Multiple pricing periods with date ranges
- Meal plan, room count, vehicle type per period
- Complete price breakdown with components
- Seasonal period badges
- Period descriptions and notes

### 4. Price Calculation Summary (NEW!)
- **Total pricing periods**: Count of all defined periods
- **Average price per period**: Quick comparison metric
- **Grand total**: Sum across all periods
- **Date range**: Overall pricing coverage
- **Price modifier alerts**: Highlights variant-specific adjustments

## Data Sources

| Section | Data Source | Notes |
|---------|-------------|-------|
| Variant Details | PackageVariant from TourPackage | Basic variant info |
| Hotel Mappings | VariantHotelMapping | Which hotel for which day |
| Hotel Images | Hotel.images | From hotel master data |
| Itinerary Info | Itinerary from TourPackage | Day titles and descriptions |
| **Room Allocations** | **Query.itineraries[].roomAllocations** | **Matched by dayNumber** |
| Pricing Details | TourPackagePricing | From selected variant |
| Price Components | PricingComponent | Breakdown by attribute |
| **Price Summary** | **Calculated from all pricings** | **Aggregated totals** |

## User Interactions

### Viewing
- Click variant tab to switch between variants
- Expand/collapse hotel accordions
- Scroll through pricing periods
- View room allocation details

### Editing
- Click "Change Hotel" to select different hotel for a day
- Changes are saved to `variantHotelOverrides`
- Modified hotels show badge
- All changes persist on save

### Understanding Pricing
- See breakdown by component (per person, per room, etc.)
- Understand seasonal variations
- Compare totals across periods
- Factor in variant modifiers

## Technical Implementation

### Component Props
```typescript
interface QueryVariantsTabProps {
  control: Control<any>;
  form: any;
  loading?: boolean;
  tourPackages: TourPackageWithVariants[];
  hotels: (Hotel & { images: Images[] })[];
  roomTypes?: RoomType[];        // NEW
  occupancyTypes?: OccupancyType[]; // NEW
  mealPlans?: MealPlan[];        // NEW
  vehicleTypes?: VehicleType[];  // NEW
}
```

### Data Flow
```
1. User selects tour package & variants in Basic Info tab
   â†“
2. Form stores: selectedVariantIds, variantHotelOverrides
   â†“
3. On save, API persists these fields + creates variant snapshots
   â†“
4. On load, form restores these fields from database
   â†“
5. Variants tab displays:
   - Variant details from selected tour package
   - Hotel mappings from variant
   - Room allocations from query itineraries (matched by day)
   - Pricing from variant pricing snapshots
   - Calculated summaries from all data
```

## Persistence

After save, the following are stored:

**In TourPackageQuery table**:
- `selectedVariantIds`: `["variant-id-1", "variant-id-2"]`
- `variantHotelOverrides`: `{ "variant-id-1": { "itinerary-id": "hotel-id" } }`

**In separate tables**:
- `QueryVariantSnapshot`: One record per selected variant
- `QueryVariantHotelSnapshot`: Hotels for each variant
- `QueryVariantPricingSnapshot`: Pricing periods for each variant
- `QueryVariantPricingComponentSnapshot`: Price breakdown

**In Query's itineraries**:
- `RoomAllocation`: Room details per day (displayed in variants tab)

## Benefits of New Features

### Room Allocations in Variants Tab
âœ… See complete accommodation details alongside hotel info
âœ… Understand room distribution across days
âœ… Verify guest assignments and voucher numbers
âœ… No need to switch between Hotels and Variants tabs

### Price Calculation Summary  
âœ… Quick overview of total costs
âœ… Understand pricing structure at a glance
âœ… Compare average vs total pricing
âœ… See date coverage for pricing
âœ… Identify variant-specific adjustments

## Migration Notes

Before these changes:
- Variants tab showed hotels and basic pricing
- Room details only in Hotels tab
- No pricing summary or totals
- Selections lost after save

After these changes:
- Variants tab shows complete information
- Room allocations integrated
- Comprehensive pricing analysis
- Selections persist correctly

## Next Steps for Users

1. **Test the persistence**: 
   - Select tour package and variants
   - Save the query
   - Reopen and verify selections are retained

2. **Review room allocations**:
   - Go to Hotels tab and configure rooms
   - Switch to Variants tab
   - Verify rooms appear for each variant/day

3. **Analyze pricing**:
   - Review pricing details for each period
   - Check the summary calculations
   - Verify price modifiers are applied

4. **Customize hotels**:
   - Change a hotel for a specific variant
   - Save and verify override persists
   - Check "Modified" badge appears

## Support

For issues or questions:
- Check `VARIANT_ENHANCEMENT_SUMMARY.md` for technical details
- Run test script: `node scripts/tests/test-variant-persistence.js`
- Review database schema in `schema.prisma`
- Contact development team for assistance
